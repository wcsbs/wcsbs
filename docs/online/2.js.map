{"version":3,"sources":["webpack:///src/components/DownloadReport.vue","webpack:///./src/components/DownloadReport.vue?2079","webpack:///./src/components/DownloadReport.vue","webpack:///./src/components/DownloadReport.vue?0e4e","webpack:///./src/components/DownloadReport.vue?93e9"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAiBA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA,wBADA;AAEA;AACA;AADA,GAFA;AAKA,8BACA,yDACA,gBADA,EAEA,WAFA,EAGA,YAHA,EAIA,cAJA,EAKA,eALA,EADA,CALA;AAcA;AACA;AAAA;AAAA;AAAA,KADA;AAEA,qBAFA;AAGA,sBAHA;AAIA;AAJA,GAdA;AAoBA;AACA;AACA,wBADA;AAEA;AAFA;AAIA,GAzBA;AA0BA;AACA,eADA,yBACA;AACA;AACA,yEACA,WADA,GAEA,KAFA,CAEA,GAFA,EAEA,CAFA;AAGA;AACA;AACA,KARA;AASA,aATA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAUA,6BAVA,GAUA,IAVA;AAWA,yBAXA,GAWA,cAXA;AAYA,uBAZA,GAYA,iBAZA;AAaA,0BAbA,GAaA,eACA,eADA,GAEA,yBAfA;AAgBA,uBAhBA,GAgBA,YAhBA;AAiBA,0BAjBA,GAiBA,UACA,SADA,GAEA,YACA,WADA,GAEA,eArBA;AAsBA,gCAtBA,GAsBA,2BAtBA;AAuBA,0BAvBA,GAuBA,kDAvBA;AAwBA,gEACA,OADA,0BACA,UADA;;AAGA,qBA3BA,GA2BA;AAAA,yBACA;AAAA;AAAA,oBADA;AAAA,iBA3BA;;AA+BA,qBA/BA,GA+BA,CA/BA;;AAAA;AAAA,sBAgCA,SAhCA;AAAA;AAAA;AAAA;;AAAA;AAAA,uBAiCA;AACA,kCADA;AAEA,wCAFA;AAGA,wCAHA;AAIA,oDAJA;AAKA;AALA,mBAOA,IAPA,CAOA;AACA;AACA;;AACA;AACA;;AACA;AACA;AACA;;AACA;AACA;AACA;AACA;AACA;AACA;;AACA;AACA;AAAA;AAAA;AACA;;AACA;AACA,iBAzBA,EA0BA,KA1BA,CA0BA;AACA;AACA;AACA,iBA7BA,CAjCA;;AAAA;AAiCA,wBAjCA;;AAAA,qBAgEA,uBAhEA;AAAA;AAAA;AAAA;;AAAA;;AAAA;AAoEA,wBApEA,CAsEA;;AAtEA,sBAuEA,kCAvEA;AAAA;AAAA;AAAA;;AAwEA;AACA;AAAA;AAAA;AAzEA;;AAAA;AAAA;AAAA,uBA6EA,SA7EA;;AAAA;AA8EA;AA9EA;AAAA;;AAAA;AAAA,iDAiFA,QAjFA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAmFA,iBAnFA,2BAmFA;AACA;AACA,KArFA;AAsFA,kBAtFA,4BAsFA;AACA;AACA;AAxFA;AA1BA,G;;;;;;;;;;;;ACxBA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAAS;AACT;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;ACrCA;AAAA;AAAA;AAAA;AAA6F;AAC3B;AACL;;;AAG7D;AAC0F;AAC1F,gBAAgB,2GAAU;AAC1B,EAAE,oFAAM;AACR,EAAE,yFAAM;AACR,EAAE,kGAAe;AACjB;AACA;AACA;AACA;;AAEA;;AAEA;AACA,IAAI,IAAU;AACd,YAAY,mBAAO,CAAC,wGAA4G;AAChI,cAAc,mBAAO,CAAC,uDAAK;AAC3B;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA,sBAAsB,+HAAqD,EAAE;AAAA;AAC7E;AACA,gBAAgB,yFAAM;AACtB,yBAAyB,kGAAe;AACxC,OAAO;AACP,KAAK;AACL;AACA;AACA;AACe,gF;;;;;;;;;;;;ACtCf;AAAA;AAAA,wCAA2R,CAAgB,+UAAG,EAAC,C;;;;;;;;;;;;ACA/S;AAAA;AAAA;AAAA;AAAA;AAAA","file":"2.js","sourcesContent":["<template>\n  <div>\n    <JsonExcel\n      class=\"btn btn-info btn-block\"\n      :worksheet=\"worksheet\"\n      :fetch=\"fetchData\"\n      :before-generate=\"startDownload\"\n      :before-finish=\"finishDownload\"\n      :name=\"getFilename()\"\n      :type=\"isSmartPhone ? 'csv' : 'xls'\"\n    >\n      {{ downloading ? `${worksheet}下载中...` : `下载${worksheet}` }}\n    </JsonExcel>\n  </div>\n</template>\n\n<script>\nimport { mapGetters } from \"vuex\";\nimport Parse from \"parse\";\nimport JsonExcel from \"vue-json-excel\";\nimport Vue from \"vue\";\nimport { v4 as uuidv4 } from \"uuid\";\nVue.component(\"JsonExcel\", JsonExcel);\n\nexport default {\n  name: \"DownloadReport\",\n  components: {\n    JsonExcel\n  },\n  computed: {\n    ...mapGetters([\n      \"isLoadingStats\",\n      \"classInfo\",\n      \"classTeams\",\n      \"isClassAdmin\",\n      \"isSystemAdmin\"\n    ])\n  },\n  props: {\n    classTeam: { type: Object, required: false },\n    worksheet: String,\n    practiceId: String,\n    forSelf: Boolean\n  },\n  data: function() {\n    return {\n      downloading: false,\n      isSmartPhone: require(\"detect-mobile-browser\")(false).isAny()\n    };\n  },\n  methods: {\n    getFilename() {\n      const date = new Date();\n      const timestamp = new Date(date.toString().split(\"GMT\")[0] + \" UTC\")\n        .toISOString()\n        .split(\".\")[0];\n      const fileExt = this.isSmartPhone ? \"csv\" : \"xls\";\n      return `${this.worksheet}_${timestamp}.${fileExt}`;\n    },\n    async fetchData() {\n      const thisComponent = this;\n      const classTeam = this.classTeam;\n      const classId = this.classInfo.id;\n      const practiceId = this.forSelf\n        ? this.practiceId\n        : this.classInfo.practiceId;\n      const forSelf = this.forSelf;\n      const classTeams = forSelf\n        ? undefined\n        : classTeam\n        ? [classTeam]\n        : this.classTeams;\n      const monthlyTotalOnly = !classTeam && !this.forSelf;\n      const reportUuid = uuidv4();\n      console.log(\n        `generateReport - forSelf: ${forSelf} reportUuid: ${reportUuid}`\n      );\n      const delay = seconds =>\n        new Promise(res => setTimeout(res, seconds * 1000));\n\n      var response,\n        retry = 3;\n      while (retry > 0) {\n        response = await Parse.Cloud.run(\"class:generateReport\", {\n          classId,\n          classTeams,\n          practiceId,\n          monthlyTotalOnly,\n          reportUuid\n        })\n          .then(result => {\n            // console.log(`generateReport - result: ${JSON.stringify(result)}`);\n            console.log(`generateReport - #result: ${result.length}`);\n            if (!forSelf) {\n              var lastTeamIndex = -1;\n              for (var i = 0; i < result.length; i++) {\n                const record = result[i];\n                const index = parseInt(record[\"组别\"]);\n                if (index != lastTeamIndex) {\n                  record[\"组员\"] = `组长${record[\"组员\"]}`;\n                  lastTeamIndex = index;\n                }\n              }\n            }\n            if (!result || result.length == 0) {\n              result = [{ 错误: \"您不是正式学员，不能下载统计报表！\" }];\n            }\n            return result;\n          })\n          .catch(e => {\n            console.log(`error in generateReport: ${e}`);\n            return e;\n          });\n\n        if (Array.isArray(response)) {\n          break;\n        }\n\n        retry--;\n\n        //{\"message\":\"XMLHttpRequest failed: \\\"Unable to connect to the Parse API\\\"\",\"code\":100}\n        if (retry == 0 || response.code != 100) {\n          thisComponent.$dialog.alert(`error in generateReport: ${response}`);\n          response = [{ 错误: `下载失败：${JSON.stringify(response)}` }];\n          break;\n        }\n\n        await delay(60);\n        console.log(\"Waited 60s\");\n      }\n\n      return response;\n    },\n    startDownload() {\n      this.downloading = true;\n    },\n    finishDownload() {\n      this.downloading = false;\n    }\n  }\n};\n</script>\n","var render = function() {\n  var _vm = this\n  var _h = _vm.$createElement\n  var _c = _vm._self._c || _h\n  return _c(\n    \"div\",\n    [\n      _c(\n        \"JsonExcel\",\n        {\n          staticClass: \"btn btn-info btn-block\",\n          attrs: {\n            worksheet: _vm.worksheet,\n            fetch: _vm.fetchData,\n            \"before-generate\": _vm.startDownload,\n            \"before-finish\": _vm.finishDownload,\n            name: _vm.getFilename(),\n            type: _vm.isSmartPhone ? \"csv\" : \"xls\"\n          }\n        },\n        [\n          _vm._v(\n            \"\\n    \" +\n              _vm._s(\n                _vm.downloading\n                  ? _vm.worksheet + \"下载中...\"\n                  : \"下载\" + _vm.worksheet\n              ) +\n              \"\\n  \"\n          )\n        ]\n      )\n    ],\n    1\n  )\n}\nvar staticRenderFns = []\nrender._withStripped = true\n\nexport { render, staticRenderFns }","import { render, staticRenderFns } from \"./DownloadReport.vue?vue&type=template&id=56adc40c&\"\nimport script from \"./DownloadReport.vue?vue&type=script&lang=js&\"\nexport * from \"./DownloadReport.vue?vue&type=script&lang=js&\"\n\n\n/* normalize component */\nimport normalizer from \"!../../node_modules/vue-loader/lib/runtime/componentNormalizer.js\"\nvar component = normalizer(\n  script,\n  render,\n  staticRenderFns,\n  false,\n  null,\n  null,\n  null\n  \n)\n\n/* hot reload */\nif (module.hot) {\n  var api = require(\"/Users/donghao/Documents/code/buddha/wcsbs/code/wcsbs-online/node_modules/vue-hot-reload-api/dist/index.js\")\n  api.install(require('vue'))\n  if (api.compatible) {\n    module.hot.accept()\n    if (!api.isRecorded('56adc40c')) {\n      api.createRecord('56adc40c', component.options)\n    } else {\n      api.reload('56adc40c', component.options)\n    }\n    module.hot.accept(\"./DownloadReport.vue?vue&type=template&id=56adc40c&\", function () {\n      api.rerender('56adc40c', {\n        render: render,\n        staticRenderFns: staticRenderFns\n      })\n    })\n  }\n}\ncomponent.options.__file = \"src/components/DownloadReport.vue\"\nexport default component.exports","import mod from \"-!../../node_modules/cache-loader/dist/cjs.js??ref--12-0!../../node_modules/babel-loader/lib/index.js!../../node_modules/cache-loader/dist/cjs.js??ref--0-0!../../node_modules/vue-loader/lib/index.js??vue-loader-options!./DownloadReport.vue?vue&type=script&lang=js&\"; export default mod; export * from \"-!../../node_modules/cache-loader/dist/cjs.js??ref--12-0!../../node_modules/babel-loader/lib/index.js!../../node_modules/cache-loader/dist/cjs.js??ref--0-0!../../node_modules/vue-loader/lib/index.js??vue-loader-options!./DownloadReport.vue?vue&type=script&lang=js&\"","export * from \"-!../../node_modules/cache-loader/dist/cjs.js?{\\\"cacheDirectory\\\":\\\"node_modules/.cache/vue-loader\\\",\\\"cacheIdentifier\\\":\\\"39b0302d-vue-loader-template\\\"}!../../node_modules/vue-loader/lib/loaders/templateLoader.js??vue-loader-options!../../node_modules/cache-loader/dist/cjs.js??ref--0-0!../../node_modules/vue-loader/lib/index.js??vue-loader-options!./DownloadReport.vue?vue&type=template&id=56adc40c&\""],"sourceRoot":""}