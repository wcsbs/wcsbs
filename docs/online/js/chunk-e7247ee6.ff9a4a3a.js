(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-e7247ee6"],{"2c634":function(e,t,s){"use strict";var n=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",[e.editing?s("b-form",{on:{submit:e.onSubmit,reset:e.onReset}},[s("h4",[e._v(e._s(e.session.name?e.session.name:"创建新课"))]),s("b-input-group",{staticClass:"mt-3",attrs:{prepend:"选择课程："}},[s("select",{directives:[{name:"model",rawName:"v-model",value:e.session.id,expression:"session.id"}],on:{change:function(t){var s=Array.prototype.filter.call(t.target.options,(function(e){return e.selected})).map((function(e){var t="_value"in e?e._value:e.value;return t}));e.$set(e.session,"id",t.target.multiple?s:s[0])}}},e._l(e.newClassSessions,(function(t){return s("option",{key:t.id,domProps:{value:t.id}},[e._v(e._s(t.name))])})),0)]),s("b-form-textarea",{attrs:{placeholder:"输入上课通知",rows:"8","max-rows":"20"},model:{value:e.session.description,callback:function(t){e.$set(e.session,"description",t)},expression:"session.description"}}),s("b-input-group",{staticClass:"mt-3",attrs:{prepend:"选择日期："}},[s("v-date-picker",{attrs:{"input-props":{readonly:!0}},model:{value:e.session.scheduledAt,callback:function(t){e.$set(e.session,"scheduledAt",t)},expression:"session.scheduledAt"}}),s("b-input-group-append",[s("b-button",{attrs:{type:"submit",variant:"primary"}},[e._v("提交")]),e.session.creating?e._e():s("b-button",{attrs:{type:"reset",variant:"primary"}},[e._v("取消")])],1)],1)],1):s("b-card",{staticClass:"text-center",attrs:{header:e.session.name}},[s("b-card-text",[s("b-input-group",{staticClass:"mt-3",attrs:{prepend:"上课时间："}},[s("b-form-input",{attrs:{readonly:""},model:{value:e.session.scheduledAtLocalDateTimeString,callback:function(t){e.$set(e.session,"scheduledAtLocalDateTimeString",t)},expression:"session.scheduledAtLocalDateTimeString"}}),s("b-input-group-append",[e.isClassAdmin||e.isTeachingAssistant?s("b-button",{attrs:{variant:"warning"},on:{click:e.editSession}},[e._v("修改")]):e._e(),s("b-button",{attrs:{variant:"info",href:e.addToGoogleCalendarUrl(),target:"_blank"}},[s("b-icon",{attrs:{icon:"calendar-plus"}})],1)],1)],1),s("b-input-group",{staticClass:"mt-3",attrs:{prepend:"课前学习："}},[s("b-form-input",{attrs:{readonly:""},model:{value:e.session.materialState,callback:function(t){e.$set(e.session,"materialState",t)},expression:"session.materialState"}}),s("b-input-group-append",[s("b-button",{attrs:{variant:"info",href:e.session.url,target:"_blank"}},[s("b-icon",{attrs:{icon:"book"}})],1)],1)],1),s("b-input-group",{staticClass:"mt-3",attrs:{prepend:"上课出勤："}},[s("b-form-input",{attrs:{readonly:""},model:{value:e.session.attendanceState,callback:function(t){e.$set(e.session,"attendanceState",t)},expression:"session.attendanceState"}}),s("b-input-group-append",[e.session.showAttendanceButton?s("b-button",{attrs:{variant:"warning"},on:{click:function(t){return e.updateAttendance()}}},[e._v(e._s(e.attendanceButtonName()))]):e._e(),s("b-button",{attrs:{variant:"info"},on:{click:function(t){e.session.showDescription=!e.session.showDescription}}},[e.session.showDescription?s("b-icon",{attrs:{icon:"chevron-double-up"}}):s("b-icon",{attrs:{icon:"chevron-double-down"}})],1)],1)],1),e.session.showDescription?s("b-form-textarea",{attrs:{placeholder:"Auto height textarea",rows:"3","max-rows":"8"},model:{value:e.session.description,callback:function(t){e.$set(e.session,"description",t)},expression:"session.description"}}):e._e()],1)],1)],1)},i=[],a=(s("a481"),s("7f7f"),s("4917"),s("bf48")),o=s.n(a),r={name:"ClassSession",props:{classSession:{type:Object,required:!0},attendance:{type:Object,required:!0},classInfo:{type:Object,required:!1},newSessions:{type:Array,required:!1},isStudent:{type:Boolean,default:!0},isClassAdmin:Boolean,isTeachingAssistant:Boolean},data:function(){return{session:this.classSession.dummy?{creating:!0,editing:!0}:this.initSession(),newClassSessions:[],editing:this.classSession.dummy}},mounted:function(){this.buildNewClassSessions()},methods:{initSession:function(){return{id:this.classSession.id,name:this.classSession.get("name"),url:this.classSession.get("url"),description:this.classSession.get("description"),scheduledAt:this.classSession.get("scheduledAt"),scheduledAtLocalDateTimeString:this.toLocalDateTimeString(this.classSession.get("scheduledAt")),showDescription:!1,showAttendanceButton:this.needToShowAttendanceButton(this.classSession.get("scheduledAt")),attendanceState:this.toAttendanceStateString(this.attendance),materialState:this.toMaterialStateString(this.attendance)}},buildNewClassSessions:function(){if(this.newClassSessions=[],this.editing)if(this.classSession.dummy)this.newClassSessions=this.newSessions;else{var e={id:this.classSession.id,name:this.classSession.get("name")};console.log("".concat(JSON.stringify(e)));for(var t=parseInt(e.name.match(/(\d+)/)[0]),s=!1,n=0;n<this.newSessions.length;n++){var i=this.newSessions[n];!s&&parseInt(i.name.match(/(\d+)/)[0])>t&&(this.newClassSessions.push(e),s=!0),this.newClassSessions.push(i)}}},toLocalDateTimeString:function(e){var t={year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"numeric"};return e.toLocaleDateString("zh-CN",t)},toLocalDateString:function(e){var t={year:"numeric",month:"short",day:"numeric"};return e.toLocaleDateString("zh-CN",t)},needToShowAttendanceButton:function(e){if(this.isStudent){var t=new Date;return t.getTime()<e.getTime()+2592e5}return!1},toAttendanceStateString:function(e){if(e){if(e.qingJia)return"已请假";if(1==e.shangKe)return"已上课";if(0==e.shangKe&&void 0==e.qingJia)return"未上课"}return"未报考勤"},toMaterialStateString:function(e){var t="未看传承",s="未看法本";return e&&(e.chuanCheng&&(t="已看传承"),1==e.faBen&&(s="已看法本")),"".concat(t,"/").concat(s)},addToGoogleCalendarUrl:function(){var e=this.session.scheduledAt,t=new Date;t.setTime(e.getTime()+144e5),e=e.toISOString().replace(/.000/g,"").replace(/:/g,"").replace(/-/g,""),t=t.toISOString().replace(/.000/g,"").replace(/:/g,"").replace(/-/g,"");var s="".concat(this.session.name,"&details=").concat(this.session.description);return s=encodeURI(s),"https://www.google.com/calendar/render?action=TEMPLATE&text=".concat(s,"&dates=").concat(e,"%2F").concat(t)},attendanceButtonName:function(){var e=new Date;return e<this.classSession.get("scheduledAt")?this.attendance.qingJia?"取消请假":"我要请假":void 0!=this.attendance.shangKe?"我要改考勤":"我要报考勤"},updateAttendance:function(){var e=new Date,t={},s="确认";e<this.classSession.get("scheduledAt")?this.attendance.qingJia?(t.qingJia=!1,s+="取消请假"):(t.qingJia=!0,t.shangKe=!1,s+="请假"):this.attendance.shangKe?(t.shangKe=!1,s+="没有上课"):(t.shangKe=!0,s+="已上课");var n=this.classSession.get("url"),i=this,a={okText:"确认",cancelText:"取消"},r={title:this.session.name,body:s+"?"};this.$dialog.confirm(r,a).then((function(e){console.log("".concat(JSON.stringify(e))),o.a.Cloud.run("home:updateAttendance",{pathname:n,attendance:t}).then((function(e){console.log("updateAttendance - result: ".concat(JSON.stringify(e))),void 0!=e.qingJia&&(i.attendance.qingJia=e.qingJia),void 0!=e.shangKe&&(i.attendance.shangKe=e.shangKe),i.session.attendanceState=i.toAttendanceStateString(i.attendance)})).catch((function(e){console.log("error in updateAttendance: ".concat(e))}))})).catch((function(e){console.log("error: ".concat(e))}))},editSession:function(){this.session=this.initSession(),this.editing=!0,this.buildNewClassSessions()},onReset:function(e){e.preventDefault(),this.editing=!1},onSubmit:function(e){e.preventDefault();var t=this.session.id;console.log("sessionId: ".concat(t));var s=this.classInfo.classSessions.filter((function(e){return e.id===t}))[0],n={okText:"确认",cancelText:"取消"},i={title:this.classInfo.name,body:"".concat(this.session.creating?"创建新课":"修改"," 《").concat(s.get("name"),"》 @ ").concat(this.toLocalDateString(this.session.scheduledAt),"？")},a=this,r=this.session;r.oldId=this.classSession.id;var c=new Date(r.scheduledAt);c.setHours(9),r.scheduledAt=c,this.$dialog.confirm(i,n).then((function(){o.a.Cloud.run("class:updateClassSession",{session:r}).then((function(e){console.log("updateClassSession - result: ".concat(JSON.stringify(e))),a.$router.go()})).catch((function(e){console.log("error in updateAttendance: ".concat(e))}))})).catch((function(e){console.log("error: ".concat(e))}))}}},c=r,l=s("2877"),u=Object(l["a"])(c,n,i,!1,null,null,null);t["a"]=u.exports},"662a":function(e,t,s){"use strict";s.r(t);var n=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",[e.isLoadingSessions?s("div",{staticClass:"classSession-preview"},[e._v("\n    正在获取上课列表...\n  ")]):s("div",[s("h3",{domProps:{textContent:e._s(e.classInfo.name)}}),s("div",{staticClass:"input-group mb-3"},[s("input",{directives:[{name:"model",rawName:"v-model",value:e.filterText,expression:"filterText"}],staticClass:"form-control",attrs:{type:"text","aria-describedby":"basic-addon2",placeholder:"搜索"},domProps:{value:e.filterText},on:{change:function(t){return e.filterSessions(e.filterText)},input:function(t){t.target.composing||(e.filterText=t.target.value)}}}),s("div",{staticClass:"input-group-append"},[s("button",{staticClass:"btn btn-outline-secondary",attrs:{type:"button"},on:{click:e.clearFilter}},[e._v("\n          清除\n        ")]),e.isClassAdmin||e.isTeachingAssistant?s("button",{staticClass:"btn btn-outline-secondary",attrs:{type:"button"},on:{click:e.createSession}},[e._v("\n          "+e._s(e.creatingSession?"取消创建":"创建新课")+"\n        ")]):e._e()])]),0===e.classSessions.length?s("div",[e._v("\n      没有找到上课记录！\n    ")]):e._e(),e.creatingSession?s("ClassSession",{attrs:{classInfo:e.classInfo,classSession:e.newClassSession,attendance:e.newAttendance,newSessions:e.newSessions}}):e._e(),e._l(e.classSessions,(function(t,n){return s("ClassSession",{key:t.id+n,attrs:{classInfo:e.classInfo,classSession:t,attendance:e.attendances[n],newSessions:e.newSessions,isClassAdmin:e.isClassAdmin,isTeachingAssistant:e.isTeachingAssistant,isStudent:e.isStudent}})}))],2)])},i=[],a=(s("8e6e"),s("ac6a"),s("456d"),s("bd86")),o=s("2f62"),r=s("2c634"),c=s("6c33"),l=s("4360");function u(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function d(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?u(Object(s),!0).forEach((function(t){Object(a["a"])(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):u(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}var h={name:"SessionManagement",components:{ClassSession:r["a"]},computed:d({},Object(o["b"])(["isLoadingSessions","classInfo","classSessions","attendances","newSessions","isClassAdmin","isTeachingAssistant","isStudent"])),beforeRouteEnter:function(e,t,s){l["a"].dispatch(c["d"],e.params["buddhaClassId"]).then((function(){s()}))},data:function(){return{filterText:"",creatingSession:!1,newClassSession:{dummy:!0},newAttendance:{dummy:!0}}},methods:{filterSessions:function(e){this.$store.dispatch(c["f"],e)},clearFilter:function(){this.filterText="",this.$store.dispatch(c["f"],this.filterText)},createSession:function(){this.creatingSession=!this.creatingSession}}},p=h,g=s("2877"),f=Object(g["a"])(p,n,i,!1,null,null,null);t["default"]=f.exports},a481:function(e,t,s){"use strict";var n=s("cb7c"),i=s("4bf8"),a=s("9def"),o=s("4588"),r=s("0390"),c=s("5f1b"),l=Math.max,u=Math.min,d=Math.floor,h=/\$([$&`']|\d\d?|<[^>]*>)/g,p=/\$([$&`']|\d\d?)/g,g=function(e){return void 0===e?e:String(e)};s("214f")("replace",2,(function(e,t,s,f){return[function(n,i){var a=e(this),o=void 0==n?void 0:n[t];return void 0!==o?o.call(n,a,i):s.call(String(a),n,i)},function(e,t){var i=f(s,e,this,t);if(i.done)return i.value;var d=n(e),h=String(this),p="function"===typeof t;p||(t=String(t));var m=d.global;if(m){var v=d.unicode;d.lastIndex=0}var b=[];while(1){var w=c(d,h);if(null===w)break;if(b.push(w),!m)break;var y=String(w[0]);""===y&&(d.lastIndex=r(h,a(d.lastIndex),v))}for(var A="",C=0,x=0;x<b.length;x++){w=b[x];for(var T=String(w[0]),_=l(u(o(w.index),h.length),0),O=[],k=1;k<w.length;k++)O.push(g(w[k]));var D=w.groups;if(p){var I=[T].concat(O,_,h);void 0!==D&&I.push(D);var $=String(t.apply(void 0,I))}else $=S(T,h,_,O,D,t);_>=C&&(A+=h.slice(C,_)+$,C=_+T.length)}return A+h.slice(C)}];function S(e,t,n,a,o,r){var c=n+e.length,l=a.length,u=p;return void 0!==o&&(o=i(o),u=h),s.call(r,u,(function(s,i){var r;switch(i.charAt(0)){case"$":return"$";case"&":return e;case"`":return t.slice(0,n);case"'":return t.slice(c);case"<":r=o[i.slice(1,-1)];break;default:var u=+i;if(0===u)return s;if(u>l){var h=d(u/10);return 0===h?s:h<=l?void 0===a[h-1]?i.charAt(1):a[h-1]+i.charAt(1):s}r=a[u-1]}return void 0===r?"":r}))}}))}}]);
//# sourceMappingURL=chunk-e7247ee6.ff9a4a3a.js.map