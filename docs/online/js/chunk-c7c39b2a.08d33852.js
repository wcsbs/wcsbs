(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-c7c39b2a"],{"2c634":function(e,s,t){"use strict";var n=function(){var e=this,s=e.$createElement,t=e._self._c||s;return t("div",[e.editing?t("b-form",{on:{submit:e.onSubmit,reset:e.onReset}},[t("h4",[e._v(e._s(this.session.creating?"创建新课":e.session.name))]),t("b-input-group",{staticClass:"mt-3",attrs:{prepend:"选择日期："}},[t("v-date-picker",{attrs:{locale:"zh-CN","input-props":{readonly:!0}},model:{value:e.session.scheduledAt,callback:function(s){e.$set(e.session,"scheduledAt",s)},expression:"session.scheduledAt"}}),t("b-input-group-append",[e.session.creating?e._e():t("b-button",{attrs:{type:"reset",variant:"warning"}},[t("b-icon",{attrs:{icon:"x-circle"}})],1)],1)],1),e.moduleDropdownOptions.length>1?t("b-input-group",{staticClass:"mt-3",attrs:{prepend:"选择模块："}},[t("b-form-select",{attrs:{options:e.moduleDropdownOptions},on:{change:e.refreshUI},model:{value:e.session.moduleId,callback:function(s){e.$set(e.session,"moduleId",s)},expression:"session.moduleId"}})],1):e._e(),t("b-input-group",{staticClass:"mt-3",attrs:{prepend:"选子模块："}},[t("b-form-select",{attrs:{options:e.submoduleDropdownOptions},model:{value:e.session.submoduleId,callback:function(s){e.$set(e.session,"submoduleId",s)},expression:"session.submoduleId"}}),t("b-input-group-append",[e.canAddSubmodule?t("b-button",{attrs:{variant:"warning"},on:{click:function(s){return e.addSubmodule()}}},[e._v("加入上课内容")]):e._e(),t("b-button",{attrs:{type:"submit",variant:"success"}},[t("b-icon",{attrs:{icon:"check-circle"}})],1)],1)],1),e.classInfo.singleSubmodule?e._e():t("div",[e._l(e.session.submodules,(function(s,n){return t("b-input-group",{key:s.id+n,staticClass:"mt-3",attrs:{prepend:"上课内容："}},[t("b-form-input",{attrs:{readonly:"",value:"("+(n+1)+") "+s.name}}),t("b-input-group-append",[t("b-button",{attrs:{variant:"warning"},on:{click:function(s){return e.removeSubmodule(n)}}},[e._v("删除")])],1)],1)})),e.session.submodules.length>0?t("b-input-group",{staticClass:"mt-3",attrs:{prepend:"上课名称："}},[t("b-form-input",{model:{value:e.session.name,callback:function(s){e.$set(e.session,"name",s)},expression:"session.name"}})],1):e._e()],2),e.session.creating?e._e():t("div",[t("b-input-group",{staticClass:"mt-3",attrs:{prepend:"材料链接：",type:"url"}},[t("b-form-input",{model:{value:e.session.materialUrl,callback:function(s){e.$set(e.session,"materialUrl",s)},expression:"session.materialUrl"}})],1),t("b-input-group",{staticClass:"mt-3",attrs:{prepend:"材料名称："}},[t("b-form-input",{model:{value:e.session.materialName,callback:function(s){e.$set(e.session,"materialName",s)},expression:"session.materialName"}}),t("b-button",{attrs:{variant:"warning"},on:{click:function(s){return e.addMaterial()}}},[e._v("加入上课材料")])],1),e._l(e.session.materials,(function(s,n){return t("b-input-group",{key:s.url+n,staticClass:"mt-3",attrs:{prepend:"上课材料："}},[t("b-form-input",{attrs:{readonly:"",value:"("+(n+1)+") "+s.name}}),t("b-input-group-append",[t("b-button",{attrs:{variant:"warning"},on:{click:function(s){return e.removeMaterial(n)}}},[e._v("删除")])],1)],1)}))],2),t("b-form-textarea",{attrs:{placeholder:"输入上课通知",rows:"8","max-rows":"20"},model:{value:e.session.description,callback:function(s){e.$set(e.session,"description",s)},expression:"session.description"}})],1):t("b-card",{staticClass:"text-center",attrs:{header:e.session.name}},[t("b-card-text",[t("b-input-group",{staticClass:"mt-3",attrs:{prepend:"上课时间："}},[t("b-form-input",{attrs:{readonly:""},model:{value:e.session.scheduledAtLocalDateTimeString,callback:function(s){e.$set(e.session,"scheduledAtLocalDateTimeString",s)},expression:"session.scheduledAtLocalDateTimeString"}}),t("b-input-group-append",[e.forApplication||!e.classInfo||e.session.creating||!e.isClassAdmin&&!e.isTeachingAssistant?e._e():t("b-button",{attrs:{variant:"warning"},on:{click:e.editSession}},[e._v("修改")])],1)],1),1==e.sessionDetails.submodules.length?t("b-input-group",{staticClass:"mt-3",attrs:{prepend:"课前学习："}},[t("b-form-input",{attrs:{readonly:""},model:{value:e.session.prestudyState,callback:function(s){e.$set(e.session,"prestudyState",s)},expression:"session.prestudyState"}}),t("b-input-group-append",[t("b-button",{attrs:{variant:"info",href:e.sessionDetails.submodules[0].url,target:"_blank"}},[t("b-icon",{attrs:{icon:"book"}})],1)],1)],1):e._l(e.sessionDetails.submodules,(function(s,n){return t("div",{key:s.id+n},[t("b-link",{attrs:{href:s.url,target:"_blank"}},[e._v(e._s("("+(n+1)+") "+s.name))]),t("b-input-group",{staticClass:"mt-3",attrs:{prepend:"课前学习："}},[t("b-form-input",{attrs:{readonly:"",value:e.toPrestudyStateString(e.sessionDetails,n)}}),t("b-input-group-append",[t("b-button",{attrs:{variant:"info",href:s.url,target:"_blank"}},[t("b-icon",{attrs:{icon:"book"}})],1)],1)],1)],1)})),e.session.forApplication?e._e():t("b-input-group",{staticClass:"mt-3",attrs:{prepend:"上课出勤："}},[t("b-form-input",{attrs:{readonly:""},model:{value:e.session.attendanceState,callback:function(s){e.$set(e.session,"attendanceState",s)},expression:"session.attendanceState"}}),t("b-input-group-append",[e.needToShowAttendanceButton()?t("b-button",{attrs:{variant:"warning"},on:{click:function(s){return e.updateAttendance()}}},[e._v(e._s(e.attendanceButtonName()))]):e._e(),t("b-button",{attrs:{variant:"info"},on:{click:function(s){e.session.showMoreDetails=!e.session.showMoreDetails}}},[e.session.showMoreDetails?t("b-icon",{attrs:{icon:"chevron-double-up"}}):t("b-icon",{attrs:{icon:"chevron-double-down"}})],1)],1)],1),e.session.showMoreDetails?t("div",[e._l(e.session.materials,(function(e,s){return t("b-input-group",{key:e.url+s,staticClass:"mt-3",attrs:{prepend:"上课材料："}},[t("b-form-input",{attrs:{readonly:"",value:"("+(s+1)+") "+e.name}}),t("b-input-group-append",[t("b-button",{attrs:{variant:"info",href:e.url,target:"_blank"}},[t("b-icon",{attrs:{icon:"book"}})],1)],1)],1)})),t("b-form-textarea",{attrs:{placeholder:"",rows:"8","max-rows":"20",readonly:""},model:{value:e.session.description,callback:function(s){e.$set(e.session,"description",s)},expression:"session.description"}})],2):e._e()],2)],1)],1)},o=[],i=(t("8e6e"),t("ac6a"),t("456d"),t("6762"),t("2fdb"),t("55dd"),t("7f7f"),t("bd86")),a=t("bf48"),r=t.n(a),c=t("2f62");function l(e,s){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);s&&(n=n.filter((function(s){return Object.getOwnPropertyDescriptor(e,s).enumerable}))),t.push.apply(t,n)}return t}function u(e){for(var s=1;s<arguments.length;s++){var t=null!=arguments[s]?arguments[s]:{};s%2?l(Object(t),!0).forEach((function(s){Object(i["a"])(e,s,t[s])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach((function(s){Object.defineProperty(e,s,Object.getOwnPropertyDescriptor(t,s))}))}return e}var d={name:"ClassSession",props:{classSession:{type:Object,required:!0},sessionDetails:{type:Object,required:!1},classInfo:{type:Object,required:!1},newSessions:{type:Array,required:!1},forApplication:Boolean,forAdmin:Boolean},data:function(){return{session:this.classSession.dummy?{creating:!0,editing:!0,submodules:[]}:this.initSession(),moduleDropdownOptions:[],submoduleDropdownOptions:[],editing:this.classSession.dummy,canAddSubmodule:!1}},computed:u({},Object(c["b"])(["isClassAdmin","isTeachingAssistant","isStudent"])),mounted:function(){this.refreshUI()},methods:{initSession:function(){return{id:this.classSession.id,forApplication:this.classInfo?this.classInfo.forApplication:this.forApplication,name:this.classSession.get("name"),submodules:[].concat(this.sessionDetails.submodules),materials:this.classSession.get("content").materials?[].concat(this.classSession.get("content").materials):[],description:this.classSession.get("description"),scheduledAt:this.classSession.get("scheduledAt"),scheduledAtLocalDateTimeString:this.toLocalDateTimeString(this.classSession.get("scheduledAt")),showMoreDetails:!1,attendanceState:this.toAttendanceStateString(this.sessionDetails),prestudyState:this.toPrestudyStateString(this.sessionDetails,0)}},refreshUI:function(){var e=this;if(this.moduleDropdownOptions=[],this.submoduleDropdownOptions=[],this.editing){this.moduleDropdownOptions=this.classInfo.modules.map((function(e){return{value:e.id,text:e.name}}));for(var s,t=this.session,n=0;n<this.classInfo.modules.length;n++)if(s=this.classInfo.modules[n],!t.moduleId||t.moduleId==s.id)break;if(t.moduleId||(t.moduleId=s.id),console.log("refreshUI - selectedModule: ".concat(s.name)),this.submoduleDropdownOptions=this.submoduleDropdownOptions.concat(s.newSubmodules),!this.classSession.dummy)for(n=0;n<this.sessionDetails.submodules.length;n++){var o=this.sessionDetails.submodules[n];o.moduleId==s.id&&(this.submoduleDropdownOptions.push(o),console.log("refreshUI - pushed: ".concat(o.name)))}if(!this.classInfo.singleSubmodule){var i=function(){var t=e.session.submodules[n];t.moduleId==s.id&&(e.submoduleDropdownOptions=e.submoduleDropdownOptions.filter((function(e){return e.id!=t.id})))};for(n=0;n<this.session.submodules.length;n++)i()}if(this.submoduleDropdownOptions.length>0){this.submoduleDropdownOptions.sort((function(e,s){var t=e.index,n=s.index;return t>n?1:n>t?-1:0}));var a=this.classInfo.singleSubmodule&&!this.classSession.dummy?this.session.submodules[0]:this.submoduleDropdownOptions[0];console.log("refreshUI - selectedSubmodule: ".concat(a.name)),this.session.submoduleId=a.id,this.canAddSubmodule=!this.classInfo.singleSubmodule}else this.canAddSubmodule=!1;this.submoduleDropdownOptions=this.submoduleDropdownOptions.map((function(e){return{value:e.id,text:e.name}}))}},addSubmodule:function(){var e,s,t=this.session;console.log("addSubmodule - moduleId: ".concat(t.moduleId," submoduleId: ").concat(t.submoduleId));for(var n=0;n<this.classInfo.modules.length;n++)if(e=this.classInfo.modules[n],!t.moduleId||t.moduleId==e.id)break;for(n=0;n<this.sessionDetails.submodules.length;n++){var o=this.sessionDetails.submodules[n];if(o.id==t.submoduleId){s=o;break}}if(!s)for(n=0;n<e.newSubmodules.length;n++){var i=e.newSubmodules[n];if(i.id==t.submoduleId){s=i;break}}t.submodules.push(s),t.name&&!this.classInfo.singleSubmodule||(t.name=s.name),this.classInfo.singleSubmodule?console.log("addSubmodule - selectedModule: ".concat(e.name," selectedSubmodule: ").concat(s.name)):this.refreshUI()},removeSubmodule:function(e){this.session.submodules.splice(e,1),this.refreshUI()},addMaterial:function(){this.session.materials.push({name:this.session.materialName,url:this.session.materialUrl}),this.session.materialName="",this.session.materialUrl=""},removeMaterial:function(e){this.session.materials.splice(e,1)},toLocalDateTimeString:function(e){var s={year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"numeric"};return e.toLocaleDateString("zh-CN",s)},toLocalDateString:function(e){var s={year:"numeric",month:"short",day:"numeric"};return e.toLocaleDateString("zh-CN",s)},needToShowAttendanceButton:function(){return this.isStudent&&!this.forAdmin&&!this.forApplication},toAttendanceStateString:function(e){if(e){if("number"==typeof e.attendance.attendance)return"".concat(e.attendance.attendance,"人已上课");if(e.attendance.onLeave)return"已请假";if(1==e.attendance.attendance)return"已上课";if(0==e.attendance.attendance&&void 0==e.attendance.onLeave)return"未上课"}return"未报考勤"},toPrestudyStateString:function(e,s){if(this.forApplication)return"请在课前看完传承/法本";var t="未看传承",n="未看法本";if(e&&e.submodules[s].studyRecord){var o=e.submodules[s].studyRecord;"number"==typeof o.lineage?t="".concat(o.lineage,"人已看传承"):o.lineage&&(t="已看传承"),"number"==typeof o.textbook?n="".concat(o.textbook,"人已看法本"):o.textbook&&(n="已看法本")}return"".concat(t,"/").concat(n)},attendanceButtonName:function(){var e=new Date;return e<this.classSession.get("scheduledAt")?this.sessionDetails.attendance.onLeave?"取消请假":"我要请假":void 0!=this.sessionDetails.attendance.attendance?"我要改考勤":"我要报考勤"},updateAttendance:function(){var e=new Date,s="确认",t=this.sessionDetails.attendance;e<this.classSession.get("scheduledAt")?t.onLeave?(t.onLeave=!1,s+="取消请假"):(t.onLeave=!0,t.attendance=!1,s+="请假"):t.attendance?(t.attendance=!1,s+="没有上课"):(t.attendance=!0,s+="已上课");var n=this.classSession.id,o={okText:"确认",cancelText:"取消",loader:!0},i={title:this.session.name,body:s+"?"},a=this;this.$dialog.confirm(i,o).then((function(e){r.a.Cloud.run("home:updateAttendanceV2",{sessionId:n,attendance:t}).then((function(s){console.log("updateAttendanceV2 - result: ".concat(JSON.stringify(s))),void 0!=s.attendance.onLeave&&(a.sessionDetails.attendance.onLeave=s.attendance.onLeave),void 0!=s.attendance.attendance&&(a.sessionDetails.attendance.attendance=s.attendance.attendance),a.session.attendanceState=a.toAttendanceStateString(a.sessionDetails),e.close()})).catch((function(s){console.log("error in updateAttendanceV2: ".concat(s)),e.close(),a.$dialog.alert("error in updateAttendance: ".concat(s))}))})).catch((function(e){console.log("error: ".concat(e))}))},editSession:function(){this.session=this.initSession(),this.editing=!0,this.refreshUI()},onReset:function(e){e.preventDefault(),this.session=this.initSession(),this.editing=!1},onSubmit:function(e){e.preventDefault(),this.classInfo.singleSubmodule&&(this.session.submodules.length>0&&this.session.submodules.splice(0,1),this.addSubmodule());var s=this.session;if(console.log("session.submodules: ".concat(JSON.stringify(s.submodules))),!s.scheduledAt||s.submodules.length<1)this.$dialog.alert("请输入上课时间和内容！");else{var t={okText:"确认",cancelText:"取消",loader:!0},n={title:this.classInfo.name,body:"".concat(s.creating?"创建新课":"修改"," 《").concat(s.name,"》 @ ").concat(this.toLocalDateString(s.scheduledAt),"？")},o=new Date(s.scheduledAt);o.setHours(s.submodules[0].url.includes("rpsxl")?9:14),s.scheduledAt=o,s.classId=this.classInfo.id;var i=this;this.$dialog.confirm(n,t).then((function(e){r.a.Cloud.run("class:updateClassSessionV2",{session:s}).then((function(s){console.log("updateClassSession - result: ".concat(JSON.stringify(s))),e.close(),window.location.reload()})).catch((function(s){console.log("error in updateClassSession: ".concat(JSON.stringify(s))),e.close(),i.$dialog.alert("error in updateClassSession: ".concat(s))}))})).catch((function(e){console.log("error: ".concat(e))}))}}}},p=d,m=t("2877"),f=Object(m["a"])(p,n,o,!1,null,null,null);s["a"]=f.exports},"2f21":function(e,s,t){"use strict";var n=t("79e5");e.exports=function(e,s){return!!e&&n((function(){s?e.call(null,(function(){}),1):e.call(null)}))}},"55dd":function(e,s,t){"use strict";var n=t("5ca1"),o=t("d8e8"),i=t("4bf8"),a=t("79e5"),r=[].sort,c=[1,2,3];n(n.P+n.F*(a((function(){c.sort(void 0)}))||!a((function(){c.sort(null)}))||!t("2f21")(r)),"Array",{sort:function(e){return void 0===e?r.call(i(this)):r.call(i(this),o(e))}})},"662a":function(e,s,t){"use strict";t.r(s);var n=function(){var e=this,s=e.$createElement,t=e._self._c||s;return t("div",[e.isLoadingSessions?t("div",[e._v("\n    正在获取课程详情...\n  ")]):t("div",[t("h3",{domProps:{textContent:e._s(e.classInfo.name)}}),t("div",{staticClass:"input-group mb-3"},[t("input",{directives:[{name:"model",rawName:"v-model",value:e.filterText,expression:"filterText"}],staticClass:"form-control",attrs:{type:"text","aria-describedby":"basic-addon2",placeholder:"搜索"},domProps:{value:e.filterText},on:{change:function(s){return e.filterSessions(e.filterText)},input:function(s){s.target.composing||(e.filterText=s.target.value)}}}),t("div",{staticClass:"input-group-append"},[t("button",{staticClass:"btn btn-outline-secondary",attrs:{type:"button"},on:{click:e.clearFilter}},[e._v("\n          清除\n        ")]),e.classInfo.forApplication?t("b-button",{attrs:{variant:"warning"},on:{click:function(s){return e.applyClass()}}},[e._v("我要报名")]):e._e(),e.classInfo.forApplication||!e.isClassAdmin&&!e.isTeachingAssistant?e._e():t("b-button",{attrs:{variant:"warning"},on:{click:e.createSession}},[e._v(e._s(e.creatingSession?"取消创建":"创建新课"))])],1)]),0===e.classSessions.length?t("div",[e._v("\n      没有找到上课记录！\n    ")]):e._e(),e.creatingSession?t("ClassSession",{attrs:{classInfo:e.classInfo,classSession:e.newClassSession}}):e._e(),e._l(e.classSessions,(function(s,n){return t("ClassSession",{key:s.id+n,attrs:{classInfo:e.classInfo,forApplication:e.classInfo.forApplication,forAdmin:e.classInfo.forAdmin,classSession:s,sessionDetails:e.sessionDetails[n]}})}))],2)])},o=[],i=(t("8e6e"),t("ac6a"),t("456d"),t("7f7f"),t("bd86")),a=t("2f62"),r=t("2c634"),c=t("6c33"),l=t("4360"),u=t("bf48"),d=t.n(u);function p(e,s){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);s&&(n=n.filter((function(s){return Object.getOwnPropertyDescriptor(e,s).enumerable}))),t.push.apply(t,n)}return t}function m(e){for(var s=1;s<arguments.length;s++){var t=null!=arguments[s]?arguments[s]:{};s%2?p(Object(t),!0).forEach((function(s){Object(i["a"])(e,s,t[s])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):p(Object(t)).forEach((function(s){Object.defineProperty(e,s,Object.getOwnPropertyDescriptor(t,s))}))}return e}var f={name:"SessionManagement",components:{ClassSession:r["a"]},computed:m({},Object(a["b"])(["isLoadingSessions","classInfo","classSessions","sessionDetails","isClassAdmin","isTeachingAssistant","isStudent"])),beforeRouteEnter:function(e,s,t){l["a"].dispatch(c["e"],e.params).then((function(){t()}))},data:function(){return{filterText:"",creatingSession:!1,newClassSession:{dummy:!0},newAttendance:{dummy:!0}}},methods:{filterSessions:function(e){this.$store.dispatch(c["g"],e)},clearFilter:function(){this.filterText="",this.$store.dispatch(c["g"],this.filterText)},createSession:function(){this.creatingSession=!this.creatingSession},applyClass:function(){var e=this.classInfo.id,s={okText:"确认",cancelText:"取消"},t={title:this.classInfo.name,body:"顶礼上师三宝！真的要报名？"},n=this;console.log("applyClass - classId: ".concat(e)),this.$dialog.confirm(t,s).then((function(){d.a.Cloud.run("class:apply",{classId:e}).then((function(e){console.log("class:apply - result: ".concat(JSON.stringify(e))),n.$router.push({name:"home"})})).catch((function(e){console.log("error in class:apply: ".concat(e))}))})).catch((function(e){console.log("error: ".concat(e))}))}}},b=f,h=t("2877"),g=Object(h["a"])(b,n,o,!1,null,null,null);s["default"]=g.exports}}]);
//# sourceMappingURL=chunk-c7c39b2a.08d33852.js.map