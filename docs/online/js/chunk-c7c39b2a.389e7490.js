(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-c7c39b2a"],{"2c634":function(e,t,s){"use strict";var n=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",[e.editing?s("b-form",{on:{submit:e.onSubmit,reset:e.onReset}},[s("h4",[e._v(e._s(this.session.creating?"创建新课":e.session.name))]),s("b-input-group",{staticClass:"mt-3",attrs:{prepend:"选择日期："}},[s("v-date-picker",{attrs:{locale:"zh-CN","input-props":{readonly:!0}},model:{value:e.session.scheduledAt,callback:function(t){e.$set(e.session,"scheduledAt",t)},expression:"session.scheduledAt"}}),s("b-input-group-append",[e.session.creating?e._e():s("b-button",{attrs:{type:"reset",variant:"warning"}},[s("b-icon",{attrs:{icon:"x-circle"}})],1),s("b-button",{attrs:{type:"submit",variant:"success"}},[s("b-icon",{attrs:{icon:"check-circle"}})],1)],1)],1),e.moduleDropdownOptions.length>1?s("b-input-group",{staticClass:"mt-3",attrs:{prepend:"选择模块："}},[s("b-form-select",{attrs:{options:e.moduleDropdownOptions},on:{change:e.refreshUI},model:{value:e.session.moduleId,callback:function(t){e.$set(e.session,"moduleId",t)},expression:"session.moduleId"}})],1):e._e(),s("b-input-group",{staticClass:"mt-3",attrs:{prepend:"选子模块："}},[s("b-form-select",{attrs:{options:e.submoduleDropdownOptions},model:{value:e.session.submoduleId,callback:function(t){e.$set(e.session,"submoduleId",t)},expression:"session.submoduleId"}}),s("b-input-group-append",[e.canAddSubmodule?s("b-button",{attrs:{variant:"warning"},on:{click:function(t){return e.addSubmodule()}}},[e._v("加入上课内容")]):e._e()],1)],1),e._l(e.session.submodules,(function(t,n){return s("b-input-group",{key:t.id+n,staticClass:"mt-3",attrs:{prepend:"上课内容："}},[s("b-form-input",{attrs:{readonly:"",value:"("+(n+1)+") "+t.name}}),s("b-input-group-append",[s("b-button",{attrs:{variant:"warning"},on:{click:function(t){return e.removeSubmodule(n)}}},[e._v("删除")])],1)],1)})),e.session.submodules.length>0?s("b-input-group",{staticClass:"mt-3",attrs:{prepend:"上课名称："}},[s("b-form-input",{model:{value:e.session.name,callback:function(t){e.$set(e.session,"name",t)},expression:"session.name"}})],1):e._e(),s("b-form-textarea",{attrs:{placeholder:"输入上课通知",rows:"8","max-rows":"20"},model:{value:e.session.description,callback:function(t){e.$set(e.session,"description",t)},expression:"session.description"}})],2):s("b-card",{staticClass:"text-center",attrs:{header:e.session.name}},[s("b-card-text",[s("b-input-group",{staticClass:"mt-3",attrs:{prepend:"上课时间："}},[s("b-form-input",{attrs:{readonly:""},model:{value:e.session.scheduledAtLocalDateTimeString,callback:function(t){e.$set(e.session,"scheduledAtLocalDateTimeString",t)},expression:"session.scheduledAtLocalDateTimeString"}}),s("b-input-group-append",[e.forApplication||!e.classInfo||e.session.creating||!e.isClassAdmin&&!e.isTeachingAssistant?e._e():s("b-button",{attrs:{variant:"warning"},on:{click:e.editSession}},[e._v("修改")])],1)],1),1==e.sessionDetails.submodules.length?s("b-input-group",{staticClass:"mt-3",attrs:{prepend:"课前学习："}},[s("b-form-input",{attrs:{readonly:""},model:{value:e.session.materialState,callback:function(t){e.$set(e.session,"materialState",t)},expression:"session.materialState"}}),s("b-input-group-append",[s("b-button",{attrs:{variant:"info",href:e.sessionDetails.submodules[0].url,target:"_blank"}},[s("b-icon",{attrs:{icon:"book"}})],1)],1)],1):e._l(e.sessionDetails.submodules,(function(t,n){return s("div",{key:t.id+n},[s("b-link",{attrs:{href:t.url,target:"_blank"}},[e._v(e._s("("+(n+1)+") "+t.name))]),s("b-input-group",{staticClass:"mt-3",attrs:{prepend:"课前学习："}},[s("b-form-input",{attrs:{readonly:""},model:{value:e.session.materialState,callback:function(t){e.$set(e.session,"materialState",t)},expression:"session.materialState"}}),s("b-input-group-append",[s("b-button",{attrs:{variant:"info",href:t.url,target:"_blank"}},[s("b-icon",{attrs:{icon:"book"}})],1)],1)],1)],1)})),e.session.forApplication?e._e():s("b-input-group",{staticClass:"mt-3",attrs:{prepend:"上课出勤："}},[s("b-form-input",{attrs:{readonly:""},model:{value:e.session.attendanceState,callback:function(t){e.$set(e.session,"attendanceState",t)},expression:"session.attendanceState"}}),s("b-input-group-append",[e.needToShowAttendanceButton()?s("b-button",{attrs:{variant:"warning"},on:{click:function(t){return e.updateAttendance()}}},[e._v(e._s(e.attendanceButtonName()))]):e._e(),s("b-button",{attrs:{variant:"info"},on:{click:function(t){e.session.showDescription=!e.session.showDescription}}},[e.session.showDescription?s("b-icon",{attrs:{icon:"chevron-double-up"}}):s("b-icon",{attrs:{icon:"chevron-double-down"}})],1)],1)],1),e.session.showDescription?s("b-form-textarea",{attrs:{placeholder:"",rows:"8","max-rows":"20",readonly:""},model:{value:e.session.description,callback:function(t){e.$set(e.session,"description",t)},expression:"session.description"}}):e._e()],2)],1)],1)},o=[],i=(s("8e6e"),s("ac6a"),s("456d"),s("6762"),s("2fdb"),s("55dd"),s("7f7f"),s("bd86")),a=s("bf48"),r=s.n(a),c=s("2f62");function l(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function u(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?l(Object(s),!0).forEach((function(t){Object(i["a"])(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):l(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}var d={name:"ClassSession",props:{classSession:{type:Object,required:!0},sessionDetails:{type:Object,required:!1},classInfo:{type:Object,required:!1},newSessions:{type:Array,required:!1},forApplication:Boolean,forAdmin:Boolean},data:function(){return{session:this.classSession.dummy?{creating:!0,editing:!0,submodules:[]}:this.initSession(),moduleDropdownOptions:[],submoduleDropdownOptions:[],editing:this.classSession.dummy,canAddSubmodule:!1}},computed:u({},Object(c["b"])(["isClassAdmin","isTeachingAssistant","isStudent"])),mounted:function(){this.refreshUI()},methods:{initSession:function(){return{id:this.classSession.id,forApplication:this.classInfo?this.classInfo.forApplication:this.forApplication,name:this.classSession.get("name"),submodules:[].concat(this.sessionDetails.submodules),description:this.classSession.get("description"),scheduledAt:this.classSession.get("scheduledAt"),scheduledAtLocalDateTimeString:this.toLocalDateTimeString(this.classSession.get("scheduledAt")),showDescription:!1,attendanceState:this.toAttendanceStateString(this.sessionDetails),materialState:this.toMaterialStateString(this.sessionDetails,0)}},refreshUI:function(){var e=this;if(this.moduleDropdownOptions=[],this.submoduleDropdownOptions=[],this.editing){this.moduleDropdownOptions=this.classInfo.modules.map((function(e){return{value:e.id,text:e.name}}));for(var t,s=this.session,n=0;n<this.classInfo.modules.length;n++)if(t=this.classInfo.modules[n],!s.moduleId||s.moduleId==t.id)break;if(s.moduleId||(s.moduleId=t.id),console.log("refreshUI - selectedModule: ".concat(t.name)),this.submoduleDropdownOptions=this.submoduleDropdownOptions.concat(t.newSubmodules),!this.classSession.dummy)for(n=0;n<this.sessionDetails.submodules.length;n++){var o=this.sessionDetails.submodules[n];o.moduleId==t.id&&this.submoduleDropdownOptions.push(o)}var i=function(){var s=e.session.submodules[n];s.moduleId==t.id&&(e.submoduleDropdownOptions=e.submoduleDropdownOptions.filter((function(e){return e.id!=s.id})))};for(n=0;n<this.session.submodules.length;n++)i();this.submoduleDropdownOptions.length>0?(this.submoduleDropdownOptions.sort((function(e,t){var s=e.index,n=t.index;return s>n?1:n>s?-1:0})),this.session.submoduleId=this.submoduleDropdownOptions[0].id,console.log("refreshUI - selectedSubmodule: ".concat(this.submoduleDropdownOptions[0].name)),this.canAddSubmodule=!0):this.canAddSubmodule=!1,this.submoduleDropdownOptions=this.submoduleDropdownOptions.map((function(e){return{value:e.id,text:e.name}}))}},addSubmodule:function(){var e,t=this.session;console.log("addSubmodule - moduleId: ".concat(t.moduleId," submoduleId: ").concat(t.submoduleId));for(var s=0;s<this.classInfo.modules.length;s++)if(e=this.classInfo.modules[s],!t.moduleId||t.moduleId==e.id)break;for(s=0;s<e.newSubmodules.length;s++){var n=e.newSubmodules[s];if(n.id==t.submoduleId){t.submodules.push(n),t.name||(t.name=n.name);break}}this.refreshUI()},removeSubmodule:function(e){this.session.submodules.splice(e,1),this.refreshUI()},toLocalDateTimeString:function(e){var t={year:"numeric",month:"short",day:"numeric",hour:"numeric",minute:"numeric"};return e.toLocaleDateString("zh-CN",t)},toLocalDateString:function(e){var t={year:"numeric",month:"short",day:"numeric"};return e.toLocaleDateString("zh-CN",t)},needToShowAttendanceButton:function(){return this.isStudent&&!this.forAdmin&&!this.forApplication},toAttendanceStateString:function(e){if(e){if("number"==typeof e.attendance.attendance)return"".concat(e.attendance.attendance,"人已上课");if(e.attendance.onLeave)return"已请假";if(1==e.attendance.attendance)return"已上课";if(0==e.attendance.attendance&&void 0==e.attendance.onLeave)return"未上课"}return"未报考勤"},toMaterialStateString:function(e,t){if(this.forApplication)return"请在课前看完传承/法本";var s="未看传承",n="未看法本";if(e&&e.submodules[t].studyRecord){var o=e.submodules[t].studyRecord;"number"==typeof o.lineage?s="".concat(o.lineage,"人已看传承"):o.lineage&&(s="已看传承"),"number"==typeof o.textbook?n="".concat(o.textbook,"人已看法本"):o.textbook&&(n="已看法本")}return"".concat(s,"/").concat(n)},attendanceButtonName:function(){var e=new Date;return e<this.classSession.get("scheduledAt")?this.sessionDetails.attendance.onLeave?"取消请假":"我要请假":void 0!=this.sessionDetails.attendance.attendance?"我要改考勤":"我要报考勤"},updateAttendance:function(){var e=new Date,t="确认",s=this.sessionDetails.attendance;e<this.classSession.get("scheduledAt")?s.onLeave?(s.onLeave=!1,t+="取消请假"):(s.onLeave=!0,s.attendance=!1,t+="请假"):s.attendance?(s.attendance=!1,t+="没有上课"):(s.attendance=!0,t+="已上课");var n=this.classSession.id,o={okText:"确认",cancelText:"取消",loader:!0},i={title:this.session.name,body:t+"?"},a=this;this.$dialog.confirm(i,o).then((function(e){r.a.Cloud.run("home:updateAttendanceV2",{sessionId:n,attendance:s}).then((function(t){console.log("updateAttendanceV2 - result: ".concat(JSON.stringify(t))),void 0!=t.attendance.onLeave&&(a.sessionDetails.attendance.onLeave=t.attendance.onLeave),void 0!=t.attendance.attendance&&(a.sessionDetails.attendance.attendance=t.attendance.attendance),a.session.attendanceState=a.toAttendanceStateString(a.sessionDetails),e.close()})).catch((function(t){console.log("error in updateAttendanceV2: ".concat(t)),e.close(),a.$dialog.alert("error in updateAttendance: ".concat(t))}))})).catch((function(e){console.log("error: ".concat(e))}))},editSession:function(){this.session=this.initSession(),this.editing=!0,this.refreshUI()},onReset:function(e){e.preventDefault(),this.session=this.initSession(),this.editing=!1},onSubmit:function(e){e.preventDefault();var t=this.session;if(!t.scheduledAt||t.submodules.length<1)this.$dialog.alert("请输入上课时间和内容！");else{var s={okText:"确认",cancelText:"取消",loader:!0},n={title:this.classInfo.name,body:"".concat(t.creating?"创建新课":"修改"," 《").concat(t.name,"》 @ ").concat(this.toLocalDateString(t.scheduledAt),"？")},o=new Date(t.scheduledAt);o.setHours(t.submodules[0].url.includes("rpsxl")?9:14),t.scheduledAt=o,t.classId=this.classInfo.id;var i=this;this.$dialog.confirm(n,s).then((function(e){r.a.Cloud.run("class:updateClassSessionV2",{session:t}).then((function(t){console.log("updateClassSession - result: ".concat(JSON.stringify(t))),e.close(),window.location.reload()})).catch((function(t){console.log("error in updateClassSession: ".concat(JSON.stringify(t))),e.close(),i.$dialog.alert("error in updateClassSession: ".concat(t))}))})).catch((function(e){console.log("error: ".concat(e))}))}}}},p=d,f=s("2877"),m=Object(f["a"])(p,n,o,!1,null,null,null);t["a"]=m.exports},"2f21":function(e,t,s){"use strict";var n=s("79e5");e.exports=function(e,t){return!!e&&n((function(){t?e.call(null,(function(){}),1):e.call(null)}))}},"55dd":function(e,t,s){"use strict";var n=s("5ca1"),o=s("d8e8"),i=s("4bf8"),a=s("79e5"),r=[].sort,c=[1,2,3];n(n.P+n.F*(a((function(){c.sort(void 0)}))||!a((function(){c.sort(null)}))||!s("2f21")(r)),"Array",{sort:function(e){return void 0===e?r.call(i(this)):r.call(i(this),o(e))}})},"662a":function(e,t,s){"use strict";s.r(t);var n=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",[e.isLoadingSessions?s("div",[e._v("\n    正在获取课程详情...\n  ")]):s("div",[s("h3",{domProps:{textContent:e._s(e.classInfo.name)}}),s("div",{staticClass:"input-group mb-3"},[s("input",{directives:[{name:"model",rawName:"v-model",value:e.filterText,expression:"filterText"}],staticClass:"form-control",attrs:{type:"text","aria-describedby":"basic-addon2",placeholder:"搜索"},domProps:{value:e.filterText},on:{change:function(t){return e.filterSessions(e.filterText)},input:function(t){t.target.composing||(e.filterText=t.target.value)}}}),s("div",{staticClass:"input-group-append"},[s("button",{staticClass:"btn btn-outline-secondary",attrs:{type:"button"},on:{click:e.clearFilter}},[e._v("\n          清除\n        ")]),e.classInfo.forApplication?s("b-button",{attrs:{variant:"warning"},on:{click:function(t){return e.applyClass()}}},[e._v("我要报名")]):e._e(),e.classInfo.forApplication||!e.isClassAdmin&&!e.isTeachingAssistant?e._e():s("b-button",{attrs:{variant:"warning"},on:{click:e.createSession}},[e._v(e._s(e.creatingSession?"取消创建":"创建新课"))])],1)]),0===e.classSessions.length?s("div",[e._v("\n      没有找到上课记录！\n    ")]):e._e(),e.creatingSession?s("ClassSession",{attrs:{classInfo:e.classInfo,classSession:e.newClassSession}}):e._e(),e._l(e.classSessions,(function(t,n){return s("ClassSession",{key:t.id+n,attrs:{classInfo:e.classInfo,forApplication:e.classInfo.forApplication,forAdmin:e.classInfo.forAdmin,classSession:t,sessionDetails:e.sessionDetails[n]}})}))],2)])},o=[],i=(s("8e6e"),s("ac6a"),s("456d"),s("7f7f"),s("bd86")),a=s("2f62"),r=s("2c634"),c=s("6c33"),l=s("4360"),u=s("bf48"),d=s.n(u);function p(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function f(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?p(Object(s),!0).forEach((function(t){Object(i["a"])(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):p(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}var m={name:"SessionManagement",components:{ClassSession:r["a"]},computed:f({},Object(a["b"])(["isLoadingSessions","classInfo","classSessions","sessionDetails","isClassAdmin","isTeachingAssistant","isStudent"])),beforeRouteEnter:function(e,t,s){l["a"].dispatch(c["e"],e.params).then((function(){s()}))},data:function(){return{filterText:"",creatingSession:!1,newClassSession:{dummy:!0},newAttendance:{dummy:!0}}},methods:{filterSessions:function(e){this.$store.dispatch(c["g"],e)},clearFilter:function(){this.filterText="",this.$store.dispatch(c["g"],this.filterText)},createSession:function(){this.creatingSession=!this.creatingSession},applyClass:function(){var e=this.classInfo.id,t={okText:"确认",cancelText:"取消"},s={title:this.classInfo.name,body:"顶礼上师三宝！真的要报名？"},n=this;console.log("applyClass - classId: ".concat(e)),this.$dialog.confirm(s,t).then((function(){d.a.Cloud.run("class:apply",{classId:e}).then((function(e){console.log("class:apply - result: ".concat(JSON.stringify(e))),n.$router.push({name:"home"})})).catch((function(e){console.log("error in class:apply: ".concat(e))}))})).catch((function(e){console.log("error: ".concat(e))}))}}},b=m,h=s("2877"),g=Object(h["a"])(b,n,o,!1,null,null,null);t["default"]=g.exports}}]);
//# sourceMappingURL=chunk-c7c39b2a.389e7490.js.map